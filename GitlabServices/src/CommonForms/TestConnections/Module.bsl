#Region FormHeaderItemsEventHandlers

&AtClient
Procedure Test(Команда)
	
	Var СервисGitLab;
	
	ЭтотОбъект.ResponseBody = "";
	
 	Если ( ПроверитьЗаполнение() ) Тогда
 		
		СервисGitLab = СервисGitLab();
		
		Попытка
			
			ПроверитьПодключениеКСервису( ЭтотОбъект.Адрес, СервисGitLab );
			ЭтотОбъект.ResponseBody = СервисGitLab.ТекстОтвета;

		Исключение
			
			СервисGitLab = Неопределено;

		КонецПопытки;
		
		ЭтотОбъект.РезультатПроверки = ФорматированныйРезультатПроверки( СервисGitLab );	
 		
 	КонецЕсли;
	
EndProcedure

#EndRegion

#Region Private

&AtClient
Function СервисGitLab()
	
	Var Результат;
	
	Результат = Новый Структура();
	Результат.Вставить( "Доступен", Ложь );
	Результат.Вставить( "Включен", Ложь );
	Результат.Вставить( "ТекстОтвета", "" );
	
	Возврат Результат;
	
EndFunction

&AtServerNoContext
Procedure ПроверитьПодключениеКСервису( Знач Адрес, Результат )
	
	Var ОписаниеСервиса;
	Var СервисGitLab;
	Var СервисВключен;

	ОписаниеСервиса = HTTPСервисы.ОписаниеСервисаURL( Адрес );
	
	Если ( ОписаниеСервиса = Неопределено ) Тогда
		
		Возврат;
		
	КонецЕсли;
	
	СервисGitLab = ОписаниеСервиса.Данные.Получить( "services" );
	
	Если ( СервисGitLab = Неопределено ) Тогда
		
		Возврат;
				
	КонецЕсли;
	
	Результат.Доступен = Истина;
	СервисВключен = СервисGitLab.Получить( "enabled" );
	Результат.Включен = ?( СервисВключен = Неопределено, Ложь, СервисВключен );
	Результат.ResponseBody = ОписаниеСервиса.json;

EndProcedure

&AtClient
Function ФорматированныйРезультатПроверки( Знач РезультатПроверкиСервиса )
	
	Var Сообщения;
	
	Сообщения = Новый Массив();
	
	Если ( РезультатПроверкиСервиса = Неопределено ) Тогда
		
		Сообщения.Добавить( Новый ФорматированнаяСтрока("Ошибка подключения.", , WebЦвета.Красный) );
		
	ИначеЕсли ( РезультатПроверкиСервиса.Доступен ) Тогда
		
		Сообщения.Добавить( Новый ФорматированнаяСтрока("Сервис доступен.", , WebЦвета.Зеленый) );
		
		Если ( РезультатПроверкиСервиса.Включен ) Тогда
			
			Сообщения.Добавить( Новый ФорматированнаяСтрока(" Статус работы: включен.", , WebЦвета.Зеленый) );
			
		Иначе
			
			Сообщения.Добавить( Новый ФорматированнаяСтрока(" Статус работы: выключен.", , WebЦвета.Красный) );
			
		КонецЕсли;
		
	Иначе
		
		Сообщения.Добавить( Новый ФорматированнаяСтрока("Сервис недоступен.", , WebЦвета.Красный) );
		
	КонецЕсли; 
	
	Возврат Новый ФорматированнаяСтрока( Сообщения );
	
EndFunction

#EndRegion
